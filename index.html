<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>无限暖暖随机服装生成器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap');
        :root { --bg-pink: #FFD1DC; --accent-purple: #5D2E46; --highlight-pink: #FF69B4; }
        
        body { 
            background-color: var(--bg-pink); 
            color: var(--accent-purple); 
            font-family: 'Nunito', sans-serif; 
            background-image: radial-gradient(var(--highlight-pink) 0.5px, transparent 0.5px); 
            background-size: 20px 20px; 
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .title-text { font-weight: 900; text-shadow: 2px 2px 0px rgba(255, 255, 255, 0.6); }

        .cloth-card { 
            background: white; 
            border: 3px solid var(--accent-purple); 
            border-radius: 20px; 
            box-shadow: 6px 6px 0px var(--accent-purple); 
            position: relative;
            opacity: 0; transform: translateY(20px);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .cloth-card.show { opacity: 1; transform: translateY(0); }

        .floating-bubble {
            position: absolute;
            top: 105%; left: 50%;
            transform: translateX(-50%) translateY(10px);
            width: 125%; 
            background: rgba(255, 255, 255, 0.98);
            border: 2px solid var(--accent-purple);
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            opacity: 0; visibility: hidden;
            transition: all 0.3s ease;
            z-index: 100;
            backdrop-filter: blur(5px);
        }
        .bubble-content { text-align: left; display: flex; flex-direction: column; align-items: flex-start; gap: 6px; }

        .cloth-card:hover .floating-bubble {
            opacity: 1; visibility: visible;
            transform: translateX(-50%) translateY(15px);
        }

        .panel-content { transition: all 0.3s ease; }
        .hidden-panel { display: none; }

        .btn-main { background: var(--accent-purple); box-shadow: 0px 4px 0px #3d1e2e; transition: all 0.2s; color: white; }
        .btn-main:active { transform: translateY(2px); box-shadow: 0px 1px 0px #3d1e2e; }

        #right-panel::-webkit-scrollbar { width: 6px; }
        #right-panel::-webkit-scrollbar-thumb { background: var(--accent-purple); border-radius: 10px; }

        .afd-link { color: #FF69B4; font-weight: 900; text-decoration: underline; transition: all 0.3s; padding: 2px 4px; border-radius: 4px; }
        .afd-link:hover { background-color: #FF69B4; color: white; text-decoration: none; }
    </style>
</head>
<body class="min-h-screen py-8 px-4">

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 w-full max-w-[1400px] bg-white/30 backdrop-blur-sm rounded-[3rem] p-8 border-4 border-white shadow-2xl">
        
        <div class="lg:col-span-8 flex flex-col items-center justify-between min-h-[750px] py-4">
            <h1 class="title-text text-4xl mb-6">无限暖暖随机服装生成器</h1>
            
            <div id="result-container" class="flex flex-wrap justify-center gap-14 w-full flex-grow content-center p-4">
                <div class="flex items-center justify-center border-4 border-dashed border-white rounded-[2rem] w-48 h-64 text-white font-black text-6xl opacity-60">?</div>
            </div>

            <div class="mt-10 flex items-center gap-4">
                <button onclick="handleGenerate()" class="btn-main px-10 py-3 rounded-full font-black text-lg tracking-wider">开始随机</button>
                <button onclick="toggleRightContent()" class="p-3 bg-white border-2 border-purple-800 rounded-full hover:rotate-90 transition-transform duration-500 shadow-sm text-lg" title="细节筛选">⚙️</button>
            </div>
        </div>

        <div id="right-panel" class="lg:col-span-4 bg-white/80 rounded-[2.5rem] p-8 border-2 border-white shadow-inner overflow-y-auto max-h-[750px]">
            
            <div id="info-content" class="panel-content space-y-5 text-sm leading-relaxed text-purple-900/80">
                <h2 class="text-2xl font-black border-b-2 border-pink-200 pb-2 text-purple-900">✨ 网站说明</h2>
                <p class="font-bold text-base text-purple-900">欢迎大家使用无限暖暖随机服装挑战生成器！</p>
                <p>在这里你可以随机服饰，我会为你随机生成1~3件非同一部位的服饰，你可以进行搭配挑战，染色或者独具风格的穿搭让你的搭配看起来更加炫酷！</p>
                <p>非常欢迎大家使用并分享到社交平台！期待大家的友好使用和交流！</p>
                
                <div class="bg-pink-100/60 p-5 rounded-2xl border border-pink-200 space-y-3">
                    <p>如果你想支持我，请订阅我的爱发电：<a href="https://afdian.com/a/JINJIUMI" target="_blank" class="afd-link">JIN</a>，我会接受大家的建议并采纳！</p>
                    <p class="text-xs italic opacity-70">呜呜一个人数据统计和注入图片不易，非常感谢大家的支持!</p>
                </div>
                <p class="text-[11px] opacity-60 pt-4 border-t border-purple-100">如有侵权非常感谢可以提醒我！我会非常快速地处理！</p>
            </div>

            <div id="filter-content" class="panel-content hidden-panel space-y-6">
                <div class="flex justify-between items-center border-b-2 border-purple-200 pb-2">
                    <h2 class="text-xl font-black text-purple-900">⚙️ 细节筛选</h2>
                    <button onclick="toggleRightContent()" class="text-xs font-bold text-pink-500 hover:underline">返回说明</button>
                </div>
                
                <div class="space-y-6">
                    <div class="grid gap-4 bg-white/60 p-4 rounded-2xl border border-pink-50">
                        <div>
                            <span class="font-black text-sm italic">主要服饰数量: <span id="main-val" class="text-pink-600">1</span></span>
                            <input type="range" id="main-limit" min="1" max="3" value="1" class="w-full mt-2" oninput="updateVal('main')">
                        </div>
                        <div>
                            <span class="font-black text-sm italic">饰品数量: <span id="acc-val" class="text-pink-600">0</span></span>
                            <input type="range" id="acc-limit" min="0" max="3" value="0" class="w-full mt-2" oninput="updateVal('acc')">
                        </div>
                    </div>

                    <div class="space-y-6">
                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <span class="font-black text-sm border-l-4 border-pink-400 pl-2">主要服饰分类</span>
                                <label class="text-[10px] flex items-center gap-1 cursor-pointer font-bold bg-pink-50 px-2 py-0.5 rounded-md">
                                    <input type="checkbox" id="all-main" checked onchange="toggleGroup('main', this.checked)"> 全选
                                </label>
                            </div>
                            <div id="main-list" class="flex flex-wrap gap-1.5"></div>
                        </div>

                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <span class="font-black text-sm border-l-4 border-pink-400 pl-2">额外饰品分类</span>
                                <label class="text-[10px] flex items-center gap-1 cursor-pointer font-bold bg-pink-50 px-2 py-0.5 rounded-md">
                                    <input type="checkbox" id="all-acc" onchange="toggleGroup('acc', this.checked)"> 全选
                                </label>
                            </div>
                            <div id="acc-list" class="flex flex-wrap gap-1.5"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="w-full text-center py-8 mt-4 opacity-50 text-[10px] md:text-[11px] leading-relaxed max-w-4xl mx-auto px-6">
        <div class="border-t border-white/40 pt-6 space-y-2">
            <p class="font-bold text-purple-900/80 uppercase tracking-widest">Copyright & Disclaimer</p>
            <p>本站为《无限暖暖》非盈利同人工具，仅供穿搭灵感交流使用。本站所使用的游戏美术资产版权均归原权利人（叠纸游戏/Papergames）所有。</p>
            <p>所得款项将仅用于服务器成本及开发者劳动力补贴，并非素材之售卖。本站与官方无关，如有侵权请联系开发者（JIN）处理。</p>
        </div>
    </footer>

    <script src="data.js"></script>

    <script>
        const RAW_BASE = "https://raw.githubusercontent.com/jinxinyi599/my_outfit_assets/main/";
        const IMG_URL = RAW_BASE + "images/";
        const UI_URL = RAW_BASE + "ui/";

        const CATEGORY_MAP = {
            main: [{id:'hair',n:'发型'},{id:'out',n:'外套'},{id:'dress',n:'连衣裙'},{id:'top',n:'上衣'},{id:'bottom',n:'下装'},{id:'socks',n:'袜子'},{id:'shoes',n:'鞋子'}],
            acc: [{id:'acc_hair',n:'发饰'},{id:'acc_hat',n:'帽子'},{id:'acc_ear',n:'耳饰'},{id:'acc_neck',n:'颈饰'},{id:'acc_wrist',n:'腕饰'},{id:'acc_choker',n:'项圈'},{id:'acc_glove',n:'手套'},{id:'acc_face',n:'面饰'},{id:'acc_chest',n:'胸饰'},{id:'acc_pendant',n:'挂饰'},{id:'acc_back',n:'背饰'},{id:'acc_ring',n:'戒指'},{id:'acc_arm',n:'臂饰'},{id:'acc_handheld',n:'手持物'},{id:'acc_paint',n:'绘肤'}]
        };

        function init() {
            const render = (gid, data, isDef) => {
                document.getElementById(`${gid}-list`).innerHTML = data.map(c => `
                    <label class="flex items-center gap-1 bg-white px-2 py-1 rounded-full border border-pink-100 hover:border-pink-300 cursor-pointer text-[11px] shadow-sm">
                        <input type="checkbox" class="${gid}-item" data-id="${c.id}" ${isDef ? 'checked' : ''} onchange="updateParent('${gid}')"> ${c.n}
                    </label>`).join('');
            };
            render('main', CATEGORY_MAP.main, true);
            render('acc', CATEGORY_MAP.acc, false);
            updateVal('main'); updateVal('acc');
        }

        function toggleGroup(g, isChecked) {
            document.querySelectorAll(`.${g}-item`).forEach(i => i.checked = isChecked);
            updateVal(g);
        }

        function updateParent(g) {
            const items = document.querySelectorAll(`.${g}-item`);
            document.getElementById(`all-${g}`).checked = [...items].every(i => i.checked) && items.length > 0;
            updateVal(g);
        }

        function toggleRightContent() {
            document.getElementById('info-content').classList.toggle('hidden-panel');
            document.getElementById('filter-content').classList.toggle('hidden-panel');
        }

        // 核心修复：更新显示的数值，但不改变滑块的固定 max 值 (3)
        function updateVal(t) {
            const slider = document.getElementById(`${t}-limit`);
            const valSpan = document.getElementById(`${t}-val`);
            const checkedCount = document.querySelectorAll(`.${t}-item:checked`).length;

            // 只有当勾选的分类极少（比如只勾了1个）时，滑块值才会被动降低
            if (parseInt(slider.value) > checkedCount && checkedCount > 0) {
                slider.value = checkedCount;
            }
            
            valSpan.innerText = slider.value;
        }

        function handleGenerate() {
            if (typeof CLOTH_DATABASE === 'undefined') return alert("数据加载中...");
            const nMain = parseInt(document.getElementById('main-limit').value);
            const nAcc = parseInt(document.getElementById('acc-limit').value);
            const pMain = [...document.querySelectorAll('.main-item:checked')].map(e => e.dataset.id);
            const pAcc = [...document.querySelectorAll('.acc-item:checked')].map(e => e.dataset.id);

            const shuffle = (arr) => [...arr].sort(() => 0.5 - Math.random());

            function pickFixed(pool, n, isMain) {
                if (n <= 0) return [];
                const validPool = pool.filter(catId => CLOTH_DATABASE.some(d => d.cat === catId));
                
                // 确定目标件数：不能超过选中的分类总数，且尽量满足滑块要求的 n
                const target = Math.min(n, validPool.length);
                
                let selected = [];
                let attempts = 0;

                // 强制凑齐逻辑：通过 100 次洗牌尝试寻找不冲突的组合
                while (attempts < 100) {
                    let temp = [];
                    let shuffled = shuffle(validPool);
                    for (let catId of shuffled) {
                        if (temp.length >= target) break;
                        if (isMain) {
                            const hasDress = temp.includes('dress');
                            const hasTopBot = temp.includes('top') || temp.includes('bottom');
                            // 互斥跳过
                            if (catId === 'dress' && hasTopBot) continue;
                            if ((catId === 'top' || catId === 'bottom') && hasDress) continue;
                        }
                        temp.push(catId);
                    }
                    
                    // 如果这轮洗牌凑够了 target 件数，就成功
                    if (temp.length >= target) {
                        selected = temp;
                        break;
                    }
                    attempts++;
                    // 如果死活凑不到 target（比如勾了头发、裙子、上衣却非要3件），则在最后一次尝试中接受最大可能值
                    if (attempts === 100) selected = temp;
                }
                return selected;
            }

            const finalSelection = [...pickFixed(pMain, nMain, true), ...pickFixed(pAcc, nAcc, false)];
            renderResult(finalSelection);
        }

        function renderResult(selection) {
            const container = document.getElementById('result-container');
            container.innerHTML = '';
            
            if (selection.length === 0) {
                container.innerHTML = '<div class="text-white/60 font-bold italic text-xl">请勾选分类并随机</div>';
                return;
            }

            selection.forEach(cat => {
                const pool = CLOTH_DATABASE.filter(d => d.cat === cat);
                if (!pool.length) return;
                const item = pool[Math.floor(Math.random() * pool.length)];
                const card = document.createElement('div');
                card.className = 'cloth-card w-44 h-60 show group';
                card.innerHTML = `
                    <img src="${IMG_URL}${item.img}" class="w-full h-full object-cover rounded-[17px]" onerror="this.src='https://via.placeholder.com/176x240?text=图片丢失'">
                    <div class="floating-bubble">
                        <div class="bubble-content">
                            <div class="flex items-center gap-2">
                                <span class="font-black text-sm text-purple-900 whitespace-nowrap">${item.name}</span>
                                <img src="${UI_URL}star${item.star}.png" class="h-3" onerror="this.style.display='none'">
                            </div>
                            <div class="flex flex-wrap gap-1 mt-1">
                                ${(item.tags || []).map(t => `<img src="${UI_URL}tag_${t}.png" class="h-5">`).join('')}
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }
        init();
    </script>
</body>
</html>